---
title: "IB9HP0_9"
author: "Group_9"
date: "2024-02-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, attr.source='.numberLines', eval = FALSE)
library(dplyr)
library(tidyr)
library(RSQLite)
library(readr)
library(ggplot2)
#packages for synthetic data generation
library(conjurer) 
library(randomNames)
library(Pareto)
library(uuid)
library(writexl)
library(charlatan) #for credit card number
```

## Implementing Logical Schema

### Create the Database and Set up the Tables

```{r connection-establishment}
# Create connection to SQL database
db_connection <- RSQLite::dbConnect(RSQLite::SQLite(),"IB9HP0_9.db")
```

### Main Tables for Entities
  
```{sql connection = db_connection}
-- Products
CREATE TABLE 'products' (
  'prod_id' INT PRIMARY KEY,
  'prod_name' VARCHAR (50) NOT NULL,
  'prod_quantity' INT NOT NULL,
  'voucher' VARCHAR (50),
  'prod_uom' VARCHAR(20) NOT NULL,
  'prod_review' VARCHAR (250), -- Composite attribute, create an extra table 'product_reviews'
  'prod_category' VARCHAR (50) NOT NULL,
  'prod_url' VARCHAR (250) NOT NULL,
  'prod_unit_price' DECIMAL NOT NULL
)
```


```{sql connection = db_connection}
-- Customers
CREATE TABLE 'customers' (
  'cust_id' INT PRIMARY KEY,
  'cust_name' VARCHAR (50) NOT NULL,
  'cust_email' VARCHAR (50) UNIQUE NOT NULL,
  'password' VARCHAR (50) NOT NULL,
  'username' VARCHAR (50) UNIQUE NOT NULL, -- fix the code
  'cust_birthdate' DATE,
  'shipping_address' VARCHAR (100) NOT NULL, -- multi-valued attribute
  'billing_address' VARCHAR (100) NOT NULL, -- multi-valued attribute
  'cust_phone' VARCHAR(10), -- multi-valued attribute, set constraint to 10 digits
--  'order_id' INT,
--FOREIGN KEY ('order_id')
--  REFERENCES orders ('order_id') -- no foreign key for customers from orders
)
```
```{sql connection = db_connection}
-- Orders
CREATE TABLE 'orders' ( 
  -- Need to name the entities as Orders because there's function Order in sql
  'order_id' INT PRIMARY KEY,
  'order_quantity' INT NOT NULL,
  'order_date' DATE,
  'order_value' DECIMAL NOT NULL, -- rename attribute from price to value
  'delivery_destination' VARCHAR (100) NOT NULL,
  'order_status' VARCHAR(100) NOT NULL,
  'prod_id' INT,
  'cust_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES products ('prod_id'),

  FOREIGN KEY ('cust_id')
    REFERENCES customers ('cust_id')
)
```

```{sql connection = db_connection}
-- Transactions
CREATE TABLE 'transactions' (
  'transaction_id' INT PRIMARY KEY,
  'transaction_status' VARCHAR (100) NOT NULL,
  'transaction_date' DATE, 
  'transaction_amount' DECIMAL NOT NULL, 
  'payment_method' VARCHAR (100) NOT NULL,
  'order_id' INT,
  FOREIGN KEY ('order_id')
    REFERENCES orders ('order_id')
)
```

```{sql connection = db_connection}
-- Supplier
CREATE TABLE 'suppliers' (
  'supplier_id' INT PRIMARY KEY,
  'supplier_name' VARCHAR (50) NOT NULL,
  'supplier_desc' VARCHAR (100) NOT NULL,
  'supplier_address' VARCHAR (100) NOT NULL,
  'supplier_contact_info' VARCHAR (10) NOT NULL,
  'prod_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES products ('prod_id')
);
```

```{sql connection = db_connection}
-- Shippers
CREATE TABLE 'shippers' (
  'shipper_id' INT PRIMARY KEY,
  'delivery_departed_date' DATE,
  'delivery_received_date' DATE,
  'estimated_delivery_date' DATE,
  'delivery_service_provider' VARCHAR (100) NOT NULL,
  'delivery_recipient_name' VARCHAR (50) NOT NULL,
  'delivery_fee' DECIMAL,
  --'delivery_id' INT,
  'delivery_status' VARCHAR (50),
  'tracking_number' INT NOT NULL,
  'delivery_destination' VARCHAR(100),
  'order_id' INT,
  FOREIGN KEY ('order_id')
    REFERENCES orders('order_id')
  FOREIGN KEY ('delivery_destination')
    REFERENCES orders('delivery_destination')
)
```

```{sql connection = db_connection}
-- Purchase Return
CREATE TABLE 'purchase_returns' (
  'return_id' INT PRIMARY KEY,
  'refund_amount' DECIMAL,
  'return_status' VARCHAR (100) NOT NULL,
  'return_date' DATE,
  'order_id' INT,
  'cust_id' INT,
  FOREIGN KEY ('order_id')
    REFERENCES orders ('order_id'),
  
  FOREIGN KEY ('cust_id')
    REFERENCES customers ('cust_id')
)
```

### Additional relational tables

```{sql connection = db_connection}
-- Product Reviews
CREATE TABLE 'product_reviews' (
  'review_desc' VARCHAR (500) NOT NULL,
  'prod_rating' INT, -- if there is limit?
  'prod_id' INT,
  'cust_id' INT,
  FOREIGN KEY ('prod_id') 
    REFERENCES products ('prod_id'),
  FOREIGN KEY ('cust_id') 
    REFERENCES customers ('cust_id')
)
```

{sql connection = db_connection}
-- Product Ads 
CREATE TABLE 'product_ads' (
  'ads_name' VARCHAR (50) NOT NULL,
  'ads_type' VARCHAR (50) NOT NULL, -- types of ads: banner, influencer's reviews, intro video, etc.
  'advertiser' VARCHAR (50) NOT NULL,
  'ads_air_date' DATETIME,
  'prod_id' INT,
  FOREIGN KEY ('prod_id') REFERENCES products ('prod_id')
)

## Generate Synthetic Data

### 'customers' table

```{r data-gen-customers}
n_customers <- 50
#Create n unique customer IDs with random names
customers_data <- 
  data.frame("cust_id" = conjurer::buildCust(n_customers),
             "cust_name" = randomNames::randomNames(n_customers)) %>% 
  separate(cust_name, into = c("last_name", "first_name"), sep = ", ")

#Update the df with email column, created by merging last and first name of the customer, with the email domain @gmail.com
customers_data <- customers_data %>% 
  unite(cust_email, c(last_name, first_name), sep = ".", remove = F) %>%
  mutate("mail_domain" = "gmail.com") %>% 
  unite(cust_email, c(cust_email, mail_domain), sep = "@", remove = T)

#Generate user's password, using random string generation package
customers_data$password <- stringi::stri_rand_strings(n=n_customers, length=8, pattern="[A-Za-z0-9]") 

#Adding customer BOD
birthdate <- sample(seq(from = as.Date("1934/01/01"), to = as.Date("2006/12/31"), by = "day"), n_customers)
customers_data$cust_birth_date <- 
  sample(birthdate, nrow(customers_data), replace = T)
  # conjurer::buildNum(n_customers, st = 1934, en = 2006, outliers = 0) %>% 
  # as.integer()

#Adding customer's telephone number
customers_data$cust_telephone <- stringi::stri_rand_strings(n=n_customers, length=7, pattern="[0-9]") #create unique random strings of 7 digits
#adding the phone code in UK
customers_data <- customers_data %>%
  mutate("phone_domain" = "075") %>% 
  unite(cust_telephone, c(phone_domain, cust_telephone), sep = "", remove = T)

#Shipping Address
cv_postcode <- read.csv("../data_uploads/ONSPD_AUG_2023_UK_CV.csv")

#Save data to data file
write.csv(customers_data, "../data_uploads/R_synth_customers.csv")
```

### 'products' table

```{r data-gen-prods}
#Getting brand and product names from Gemini
gemini_prods <- 
  read.csv("../data_uploads/gemini_data_products.csv",
           col.names = c("category", "prod_name", "prod_desc"))

#Define parameters for products
n_prods <- 20
voucher <- c("10% off", "20% off", "50% off", "Flash Sale")
ratings <- c(1,2,3,4,5)

#Assign product ID, and adding product names and URL
products_data <- 
  #generate product id
  conjurer::buildProd(n_prods, minPrice = 1, maxPrice = 100) %>% 
  #add product name and description from gemini's file
  mutate("prod_name" = sample(gemini_prods$prod_name, 20)) %>%
  left_join(select(gemini_prods, -category), 
            by = join_by(prod_name)) %>%
  #rename columns to fit schema
  rename(prod_id = SKU, prod_unit_price = Price) %>%
  #rename `sku` with `prod`
  mutate("prod_id" = gsub("sku", "prod", prod_id)) %>%
  #add product url
  mutate("web_prefix" = "https://group9.co.uk/",
         "prod_url1" = gsub(" ", "-", products_data$prod_name)) %>%
  unite(prod_url, c(prod_url1, prod_id), sep = "-", remove = F) %>%
  unite(prod_url, c(web_prefix, prod_url), sep = "", remove = T) %>%
  #drop temp url
  select(-prod_url1)

#Create vouchers
products_data$voucher[!(products_data$prod_id %in% c("prod10", "prod11")) ] <- 
  sample(voucher, sum(!(products_data$prod_id %in% c("prod10", "prod11"))), 
         replace = T)

#Create ratings
products_data$prod_rating <- 
  sample(ratings, nrow(products_data), replace = T)

#Review date
date <- sample(seq(from = as.Date("2004/03/06"), to = as.Date("2024/03/06"), by = "day"), 12)
products_data$review_date <- 
  sample(date, nrow(products_data), replace = T)

#Assign review ID
products_data <- products_data %>%
  mutate("review_id" = 
           conjurer::buildCust(sum(!is.na(products_data$prod_rating)))) %>%
  mutate(review_id = gsub("cust", "rev", review_id)) %>%
  #rearrange order of columns
  select(2,4,5,3,1,9,7,8,6)

#Save to .csv file
write.csv(products_data, "../data_uploads/R_synth_products.csv")
```

### 'orders' table

```{r data-gen-orders}
#is this order_id or order_detail_id?
orders_data <- genTrans(cycles = "y", spike = 12, outliers = 0, transactions = 10)

orders_data <- buildPareto(products_data$prod_id, 
                           orders_data$transactionID, pareto = c(80,20))
```

## Notes from Workshop Feb 23rd

### Load the Data

```{r}
print("Loading the data")
data_files <- list.files("../data_uploads", pattern = "MOCK_DATA_PRODUCTS", full.names = T)
data_to_write <- data.frame()
#for each csv file
for (file in data_files) {
  print(paste("Reading file:", file))
  this_file_rows <- read.csv(file, stringsAsFactors = F)
  data_to_write <- rbind(data_to_write, this_file_rows)
}

print("Write them to the database")

connection <- RSQLite::dbConnect(RSQLite::SQLite(),"group_9.db")
RSQLite::dbWriteTable(connection, "products", data_to_write, overwrite = T)
RSQLite::dbDisconnect(connection)
print("Done")
```


