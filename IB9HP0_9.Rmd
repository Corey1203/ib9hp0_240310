---
title: "IB9HPO_9"
output: html_document
date: "2024-03-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,attr.source='.numberLines', eval = FALSE)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
#packages for synthetic data generation
library(conjurer) 
library(randomNames)
library(Pareto)
library(uuid)
library(writexl)
library(charlatan) #for credit card number
```

```{r}
#Load library
library(RSQLite)
```

```{r}
# Create connection to SQL database
db_connection <- RSQLite::dbConnect(RSQLite::SQLite(),"IB9HP0_9.db")
```

```{sql connection = db_connection}
-- Product
CREATE TABLE 'products' (
  'prod_id' INT PRIMARY KEY,
  'prod_name' VARCHAR (50) NOT NULL,
  'prod_desc' VARCHAR (100) NOT NULL,
  'prod_uom' VARCHAR(20) NOT NULL,
  'voucher' VARCHAR (50),
  'prod_url' VARCHAR (250) NOT NULL,
  'prod_unit_price' DECIMAL NOT NULL
  );
```

```{sql connection = db_connection}
-- Review
CREATE TABLE 'reviews' (
  'review_id' INT PRIMARY KEY,
  'prod_rating' DECIMAL NOT NULL,
  'Review_date' DATE NOT NULL,
  'comment' TEXT,
  'prod_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES products('prod_id')
  );
```

```{sql connection = db_connection}
-- Membership
CREATE TABLE 'memberships' (
  'membership_type_id' INT PRIMARY KEY,
  'membership_desc' VARCHAR (50) NOT NULL
  );
```

```{sql connection = db_connection}
-- Customer
CREATE TABLE 'customers' (
  'cust_id' INT PRIMARY KEY,
  'first_name' VARCHAR (50) NOT NULL,
  'last_name' VARCHAR (50) NOT NULL,
  'cust_email' VARCHAR (50) UNIQUE,
  'password' VARCHAR (50) NOT NULL,
  'cust_bod' DATE,
  'shipping_address' VARCHAR (100) UNIQUE,
  'billing_address' VARCHAR (100) NOT NULL,
  'cust_telephone' INT UNIQUE,
  'membership_type_id' INT,
  FOREIGN KEY ('membership_type_id')
    REFERENCES memberships('membership_type_id')
  );
```

```{sql connection = db_connection}
-- Orders
CREATE TABLE 'orders' (
  'order_id' INT PRIMARY KEY,
  'cust_id' INT,
  FOREIGN KEY ('cust_id')
    REFERENCES customers('cust_id')
    );
```

```{sql connection = db_connection}
-- Payments
CREATE TABLE 'payments' (
  'payment_method' VARCHAR (100) NOT NULL,
  'payment_amount' DECIMAL NOT NULL,
  'payment_status' VARCHAR (100) NOT NULL,
  'payment_date' DATE,
  'order_id' INT,
  FOREIGN KEY ('order_id')
    REFERENCES orders('order_id')
    );
```

```{sql connection = db_connection}
-- Orders Details
CREATE TABLE 'order_details' (
  'order_quantity' INT NOT NULL,
  'order_date' DATE,
  'order_price' DECIMAL NOT NULL,
  'order_value' DECIMAL NOT NULL,
  'delivery_status' VARCHAR (50) NOT NULL,
  'delivery_fee' DECIMAL NOT NULL,
  'delivery_recipient' VARCHAR (50) NOT NULL,
  'shipper_name' VARCHAR (50) NOT NULL,
  'estimated_delivery_date' DATE,
  'delivery_departed_date' DATE,
  'delivery_received_date' DATE,
  'prod_id' INT,
  'order_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES products('prod_id'),
  FOREIGN KEY ('order_id')
    REFERENCES orders('order_id')
    );
```

```{sql connection = db_connection}
-- Supplier
CREATE TABLE 'suppliers' (
  'supplier_id' INT PRIMARY KEY,
  'supplier_name' VARCHAR (50) NOT NULL UNIQUE,
  'supplier_address' VARCHAR (100) NOT NULL UNIQUE,
  'contact_info' INT NOT NULL UNIQUE
  );
```

```{sql connection = db_connection}
-- Supply
CREATE TABLE 'supplies' (
  'inventory_quantity' INT NOT NULL,
  'sold_quantity' INT NOT NULL,
  'supplier_id' INT,
  'prod_id' INT,
  FOREIGN KEY ('supplier_id')
    REFERENCES suppliers('supplier_id'),
  FOREIGN KEY ('prod_id')
    REFERENCES products('prod_id')
  );
```

```{sql connection = db_connection}
-- Customer Query
CREATE TABLE 'customer_queries' (
  'query_id' INT PRIMARY KEY,
  'query_title' VARCHAR (50) NOT NULL,
  'query_detail' TEXT NOT NULL,
  'query_submission_date' DATE,
  'query_status' VARCHAR (50) NOT NULL,
  'cust_id' INT,
  FOREIGN KEY ('cust_id')
    REFERENCES customers('cust_id')
    );
```

```{sql connection = db_connection}
-- Category
CREATE TABLE 'categories' (
  'category_id' INT PRIMARY KEY,
  'category_name' VARCHAR (50) NOT NULL UNIQUE
  );
```

```{sql connection = db_connection}
-- Product Category
CREATE TABLE 'product_categories' (
  'category_id' INT,
  'prod_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES categories('category_id'),
  FOREIGN KEY ('prod_id')
    REFERENCES products('prod_id')
  );
```

```{sql connection = db_connection}
-- Advertiser
CREATE TABLE 'advertisers' (
  'advertiser_id' INT PRIMARY KEY,
  'ddvertiser_name' VARCHAR (50) NOT NULL UNIQUE,
  'advertiser_email' VARCHAR (50) UNIQUE
  );
```

```{sql connection = db_connection}
-- Advertisement
CREATE TABLE 'advertisements' (
  'ads_id' INT PRIMARY KEY,
  'ads_start_date' DATE,
  'ads_end_date' DATE,
  'ads_image' VARBINARY, -- is this the correct data type?
  'ads_content' TEXT,
  'prod_id' INT UNIQUE,
  'advertiser_id' INT,
  FOREIGN KEY ('prod_id')
    REFERENCES products('prod_id'),
  FOREIGN KEY ('advertiser_id')
    REFERENCES advertisers('advertiser_id')  
  );
```

## Generate Synthetic Data

### 'customers' table

```{r data-gen-customers}
n_customers <- 50
#Create n unique customer IDs with random names
customers_data <- 
  data.frame("cust_id" = conjurer::buildCust(n_customers),
             "cust_name" = randomNames::randomNames(n_customers)) %>% 
  separate(cust_name, into = c("last_name", "first_name"), sep = ", ")

#Update the df with email column, created by merging last and first name of the customer, with the email domain @gmail.com
customers_data <- customers_data %>% 
  unite(cust_email, c(last_name, first_name), sep = ".", remove = F) %>%
  mutate("mail_domain" = "gmail.com") %>% 
  unite(cust_email, c(cust_email, mail_domain), sep = "@", remove = T)

#Generate user's password, using random string generation package
customers_data$password <- stringi::stri_rand_strings(n=n_customers, length=8, pattern="[A-Za-z0-9]") 

#Adding customer BOD
birthdate <- sample(seq(from = as.Date("1934/01/01"), to = as.Date("2006/12/31"), by = "day"), n_customers)
customers_data$cust_birth_date <- 
  sample(birthdate, nrow(customers_data), replace = T)
  # conjurer::buildNum(n_customers, st = 1934, en = 2006, outliers = 0) %>% 
  # as.integer()

#Adding customer's telephone number
customers_data$cust_telephone <- stringi::stri_rand_strings(n=n_customers, length=7, pattern="[0-9]") #create unique random strings of 7 digits
#adding the phone code in UK
customers_data <- customers_data %>%
  mutate("phone_domain" = "075") %>% 
  unite(cust_telephone, c(phone_domain, cust_telephone), sep = "", remove = T)

#Shipping Address
cv_postcode <- read.csv("data_uploads/ONSPD_AUG_2023_UK_CV.csv")

#Block number [A-Z0-100]


#Save data to data file
write.csv(customers_data, "data_uploads/R_synth_customers.csv")
```

### 'products' table

```{r data-gen-prods}
#Getting brand and product names from Gemini
gemini_prods <- 
  read.csv("data_uploads/gemini_data_products.csv",
           col.names = c("category", "prod_name", "prod_desc"))

#Define parameters for products
n_prods <- 20
voucher <- c("10% off", "20% off", "50% off", "Flash Sale")
ratings <- c(1,2,3,4,5)

#Assign product ID, and adding product names and URL
products_data <- 
  #generate product id
  conjurer::buildProd(n_prods, minPrice = 1, maxPrice = 100) %>% 
  #add product name and description from gemini's file
  mutate("prod_name" = sample(gemini_prods$prod_name, 20)) %>%
  left_join(select(gemini_prods, -category), 
            by = join_by(prod_name)) %>%
  #rename columns to fit schema
  rename(prod_id = SKU, prod_unit_price = Price) %>%
  #rename `sku` with `prod`
  mutate("prod_id" = gsub("sku", "prod", prod_id)) %>%
  #add product url
  mutate("web_prefix" = "https://group9.co.uk/",
         "prod_url1" = gsub(" ", "-", products_data$prod_name)) %>%
  unite(prod_url, c(prod_url1, prod_id), sep = "-", remove = F) %>%
  unite(prod_url, c(web_prefix, prod_url), sep = "", remove = T) %>%
  #drop temp url
  select(-prod_url1)

#Create vouchers
products_data$voucher[!(products_data$prod_id %in% c("prod10", "prod11")) ] <- 
  sample(voucher, sum(!(products_data$prod_id %in% c("prod10", "prod11"))), 
         replace = T)

#Create ratings
products_data$prod_rating <- 
  sample(ratings, nrow(products_data), replace = T)

#Review date
date <- sample(seq(from = as.Date("2004/03/06"), 
                   to = as.Date("2024/03/06"), by = "day"), 12)
products_data$review_date <- 
  sample(date, nrow(products_data), replace = T)

#Assign review ID
products_data <- products_data %>%
  mutate("review_id" = 
           conjurer::buildCust(sum(!is.na(products_data$prod_rating)))) %>%
  mutate(review_id = gsub("cust", "rev", review_id)) %>%
  #rearrange order of columns
  select(2,4,5,3,1,9,7,8,6)

#Save to .csv file
write.csv(products_data, "data_uploads/R_synth_products.csv")
```

### 'orders' table

```{r data-gen-orders}
#is this order_id or order_detail_id?
orders_data <- genTrans(cycles = "y", spike = 12, outliers = 0, transactions = 10)

orders_data <- buildPareto(products_data$prod_id, 
                           orders_data$transactionID, pareto = c(80,20))
```
